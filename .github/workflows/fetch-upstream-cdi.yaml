name: Fetch upstream (CDI)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  fetch-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@f2acddfb5195534d487896a656232b016a682f3c # v1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git setup
        shell: bash
        run: |
          git config --global user.name 'drag0n141-bot[bot]'
          git config --global user.email '143080396+drag0n141-bot[bot]@users.noreply.github.com'

      - name: Fetch files
        shell: bash
        run: |
          export TAG=$(curl -s -w %{redirect_url} https://github.com/kubevirt/containerized-data-importer/releases/latest)
          export VERSION=$(echo ${TAG##*/})
          git checkout -b cdi-${VERSION} master || git checkout cdi-${VERSION}
          mkdir ./deploy

          mv ./kustomization-cdi.tmpl.yaml ./deploy/kustomization.yaml
          curl -vL -o ./deploy/1-cdi-operator.yaml https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-operator.yaml
          curl -vL -o ./deploy/2-cdi-cr.yaml https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-cr.yaml

          git add ./deploy || true
          git commit -m "feat: cdi-${VERSION}" || true

          git push origin cdi-${VERSION} || true
